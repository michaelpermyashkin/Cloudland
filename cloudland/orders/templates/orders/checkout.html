<!-- Extends base template  -->
{% extends "store/base.html" %}
<!-- Crispy forms for styling -->
{% load crispy_forms_tags %}
<!-- Loads static content to access content in static directory -->
{% load static %}
<!-- Page title for window tab -->
{% block page %}Contact{% endblock page%}
<!-- Custom page styles -->
{% block styles %}
<link href="{% static 'orders/css/checkout-styles.css' %}" rel="stylesheet">{% endblock styles %}
<!-- fills content block in base template -->
{% block content %}
<div class="container">
    <h2 class="text-center my-4">Complete Your Order</h2>
    <hr>
    <br>
    <div class="row">
        <div class="col-md-4 order-md-2 mb-4">
            <h4 class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">My cart</span>
                <span class="badge badge-success badge-pill">{{cart.cartitem_set.all|length}}</span>
            </h4>
            <ul class="list-group mb-3 rounded-0">
                {% for item in cart.cartitem_set.all %}
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                        <h6 class="my-0">{{ item.product.product_name }} x {{ item.quantity }}</h6>
                        <small class="text-muted">{{ item.product.description_short }}</small>
                    </div>
                    <span class="text-muted">${{ item.line_total }}</span>
                </li>
                {% endfor %}
                <div id="totals">
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span>Subtotal</span>
                            <h6 class="mt-1"><b>$ {{ cart.sub_total }}</b></h6>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Shipping</span>
                            <h6 class="mt-1"><b>$ {{ cart.shipping }}</b></h6>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between text-success">
                            <span>Total (USD)</span>
                            <h4><b>$ {{ cart.grand_total }}</b></h4>
                        </div>
                    </li>
                </div>
            </ul>
        </div>
        <div class="col-md-8 order-md-1">
            <!-- Billing form -->
            <h2 class="mb-3"><strong>Billing</strong></h2>
            <!-- Select billing address from profile -->
            <h4>Select or add billing address</h4>
            {% if billing_addresses %} {% for address in billing_addresses %}
            <!-- if default then set as checked -->
            {% if request.user.userdefaultaddresses.billing.id == address.id %}
            <input type="radio" name="billing_address" id="{{ address.id }}" checked/> {{address.get_address }}
            <!-- ./endif -->
            {% else %}
            <input type="radio" name="billing_address" id="{{ address.id }}" /> {{address.get_address }}
            <!-- ./endif -->
            {% endif %}
            <br>
            <!-- ./end address loop -->
            {% endfor %} {% else %}
            <div class="col-lg-12">
                <h5 class="text-muted">No billing addresses have been added</h5>
            </div>
            {% endif %} {% if billing_form %}
            <div id="billing-form" class="mt-3">
                <form method="post" action='{% url "ajax-add-user-billing-address" %}?next=orders-checkout'>
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-6 mb-0">
                            {{ billing_form.first_name|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-6 mb-0">
                            {{ billing_form.last_name|as_crispy_field }}
                        </div>
                    </div>
                    {{ billing_form.address|as_crispy_field }} {{ billing_form.address2|as_crispy_field }}
                    <div class="form-row">
                        <div class="form-group col-md-6 mb-0">
                            {{ billing_form.city|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-4 mb-0">
                            {{ billing_form.state|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-2 mb-0">
                            {{ billing_form.zipcode|as_crispy_field }}
                        </div>
                    </div>
                    {{ billing_form.default|as_crispy_field }}
                    <div class="text-right mt-3">
                        <button type="submit" class="btn btn-primary btn-block rounded-0 px-5 py-2">Add Billing Address</button>
                    </div>
                </form>
            </div>
            {% endif %}
            <!-- ./ Billing form -->

            <hr class="mb-4">

            <!-- Shipping form -->
            <h2 class="mb-3"><strong>Shipping</strong></h2>
            <!-- Select shipping address from profile -->
            <h4>Select or add shipping address</h4>
            {% if current_addresses %} {% for address in current_addresses %}
            <!-- if default then set as checked -->
            {% if request.user.userdefaultaddresses.shipping.id == address.id %}
            <input type="radio" name="shipping_address" id="{{ address.id }}" checked/> {{address.get_address }}
            <!-- ./endif -->
            {% else %}
            <input type="radio" name="shipping_address" id="{{ address.id }}" /> {{address.get_address }} {% endif %}
            <br> {% endfor %} {% else %}
            <div class="col-lg-12">
                <h5 class="text-muted">No shipping addresses have been added</h5>
            </div>
            {% endif %}
            <br>
            <div id="shipping-form">
                <form method="post" action='{% url "ajax-add-user-address" %}?next=orders-checkout'>
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-6 mb-0">
                            {{ address_form.first_name|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-6 mb-0">
                            {{ address_form.last_name|as_crispy_field }}
                        </div>
                    </div>
                    {{ address_form.address|as_crispy_field }} {{ address_form.address2|as_crispy_field }}
                    <div class="form-row">
                        <div class="form-group col-md-6 mb-0">
                            {{ address_form.city|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-4 mb-0">
                            {{ address_form.state|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-2 mb-0">
                            {{ address_form.zipcode|as_crispy_field }}
                        </div>
                    </div>
                    {{ address_form.default|as_crispy_field }}
                    <div class="text-right mt-3">
                        <button type="submit" class="btn btn-primary btn-block rounded-0 px-5 py-2">Add Shipping Address</button>
                    </div>
                </form>
            </div>
            <!-- ./Shipping Form -->

            <hr class="mb-4">

            <!-- Payment Form -->
            <h2 class="mb-3">Payment</h2>
            <div id="payment">
                <script src="https://js.stripe.com/v3/"></script>
                <form action="/charge" method="post" id="payment-form">
                    <div class="stripe-form-row mt-4">
                        <div class="row justify-content-center">
                            <div class="col-md-12">
                                <label for="card-element"><h4>Credit or debit card</h4></label>
                                <div id="card-element">
                                    <!-- A Stripe Element will be inserted here. -->
                                </div>
                            </div>
                            <div id="card-errors" role="alert"></div>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-success btn-block rounded-0 my-3">Submit Payment</button>
                        </div>
                    </div>
                </form>
                <script>
                    // Create a Stripe client.
                    var stripe = Stripe('pk_test_bDaLLnuS6dvktvlP8Iuzz3J200RUcADXjE');

                    // Create an instance of Elements.
                    var elements = stripe.elements();

                    // Custom styling can be passed to options when creating an Element.
                    // (Note that this demo uses a wider set of styles than the guide below.)
                    var style = {
                        base: {
                            color: '#32325d',
                            fontSmoothing: 'antialiased',
                            '::placeholder': {
                                color: '#aab7c4'
                            }
                        },
                        invalid: {
                            color: '#fa755a',
                            iconColor: '#fa755a'
                        }
                    };

                    // Create an instance of the card Element.
                    var card = elements.create('card', {
                        style: style
                    });

                    // Add an instance of the card Element into the `card-element` <div>.
                    card.mount('#card-element');
                </script>
            </div>
        </div>
    </div>
</div>
{%endblock content %}